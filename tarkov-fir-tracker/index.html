<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarkov FiR Tracker</title>
  <style>
    :root {
      --bg-dark: #0d1117;
      --bg-card: #161b22;
      --bg-hover: #21262d;
      --border: #30363d;
      --text: #c9d1d9;
      --text-muted: #8b949e;
      --accent: #f0883e;
      --accent-dim: #9e6a03;
      --green: #3fb950;
      --green-dim: #238636;
      --yellow: #d29922;
      --red: #f85149;
      --blue: #58a6ff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* Layout */
    .app { max-width: 1400px; margin: 0 auto; padding: 16px; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }
    header h1 { font-size: 1.5rem; color: var(--accent); font-weight: 600; }
    .header-stats {
      display: flex;
      gap: 24px;
      font-size: 0.9rem;
    }
    .header-stats .value { color: var(--accent); font-weight: 600; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 2px;
      background: var(--bg-card);
      padding: 4px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.15s;
    }
    .tab:hover { color: var(--text); background: var(--bg-hover); }
    .tab.active { background: var(--accent); color: #000; font-weight: 500; }

    .panel { display: none; }
    .panel.active { display: block; }

    /* Controls */
    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    .search-box input {
      width: 100%;
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.95rem;
    }
    .search-box input:focus { outline: none; border-color: var(--accent); }

    select, button {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
    }
    select:hover, button:hover { background: var(--bg-hover); }
    button.primary { background: var(--green-dim); border-color: var(--green-dim); }
    button.primary:hover { background: var(--green); }
    button.danger { background: #b62324; border-color: #b62324; }
    button.loading { opacity: 0.6; cursor: wait; }

    .api-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .api-badge.ok { background: var(--green-dim); color: var(--green); }
    .api-badge.loading { background: var(--accent-dim); color: var(--accent); }
    .api-badge.error { background: #b62324; color: var(--red); }

    /* Item Grid */
    .item-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .item-row {
      display: grid;
      grid-template-columns: 1fr 120px 100px 120px 100px;
      gap: 16px;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-card);
      border-radius: 8px;
      border-left: 3px solid var(--border);
      transition: all 0.15s;
    }
    .item-row:hover { background: var(--bg-hover); }
    .item-row.complete { border-left-color: var(--green); }
    .item-row.partial { border-left-color: var(--yellow); }
    .item-row.hideout { border-left-color: var(--blue); }

    .item-info h3 {
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 4px;
    }
    .item-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    /* Source Tags - Hierarchical colors */
    .source-tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    /* QuestÈöéÂ±§ - Á∑ëÁ≥ª„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ (ÊµÖ„ÅÑ=Êòé„Çã„ÅÑ, Ê∑±„ÅÑ=Êöó„ÅÑ) */
    .source-tag.quest-early { background: #238636; color: #7ee787; }
    .source-tag.quest-mid { background: #1a5c2a; color: #56d364; }
    .source-tag.quest-late { background: #0f3d1a; color: #3fb950; }
    /* HideoutÈöéÂ±§ - ÈùíÁ≥ª„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */
    .source-tag.hideout-early { background: #1f6feb; color: #a5d6ff; }
    .source-tag.hideout-mid { background: #1158c7; color: #79c0ff; }
    .source-tag.hideout-late { background: #0d419d; color: #58a6ff; }

    .tag {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.7rem;
    }
    .tag.craft { background: #388bfd26; color: var(--blue); }
    .tag.barter { background: #d2992226; color: var(--yellow); }

    .item-price {
      text-align: right;
    }
    .item-price .main { font-weight: 500; color: var(--blue); }
    .item-price .per-slot { font-size: 0.8rem; color: var(--text-muted); }

    .item-status {
      text-align: center;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .status-badge.sell { background: var(--green-dim); color: var(--green); }
    .status-badge.keep { background: var(--accent-dim); color: var(--accent); }
    .status-badge.need { background: #b6232426; color: var(--red); }

    .item-counter {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .item-counter button {
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .item-counter input {
      width: 40px;
      text-align: center;
      padding: 4px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
    }
    .item-counter .total { color: var(--text-muted); font-size: 0.85rem; }

    .item-progress {
      text-align: right;
      font-weight: 500;
    }
    .item-progress.done { color: var(--green); }

    /* Source Details (expandable) */
    .source-details {
      grid-column: 1 / -1;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
      margin-top: 8px;
    }

    /* Bulk Search Panel */
    .bulk-panel {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .bulk-panel h3 { margin-bottom: 12px; color: var(--blue); }
    .bulk-panel textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      resize: vertical;
      margin-bottom: 12px;
    }
    .bulk-panel textarea:focus { outline: none; border-color: var(--blue); }
    .bulk-actions { display: flex; gap: 8px; }

    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .summary-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 16px;
    }
    .summary-card h3 {
      font-size: 1rem;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .summary-card h3.green { color: var(--green); }
    .summary-card h3.yellow { color: var(--yellow); }
    .summary-card h3.red { color: var(--red); }

    .summary-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: var(--bg-hover);
      border-radius: 4px;
    }
    .summary-item .name { font-weight: 500; }
    .summary-item .meta { font-size: 0.85rem; color: var(--text-muted); }
    .summary-item .price { color: var(--blue); }

    /* Footer */
    footer {
      margin-top: 40px;
      padding: 20px 0;
      border-top: 1px solid var(--border);
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: center;
    }
    footer a { color: var(--accent); text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    /* Responsive */
    @media (max-width: 900px) {
      .item-row {
        grid-template-columns: 1fr 80px 80px;
      }
      .item-price, .item-status { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Tarkov FiR Tracker</h1>
      <div class="header-stats">
        <span>ÈÄ≤Êçó: <span class="value" id="stat-progress">0/0</span></span>
        <span>ÂÆå‰∫Ü: <span class="value" id="stat-complete">0</span></span>
        <span>Â£≤Âç¥ÂèØ: <span class="value" id="stat-sellable">0</span></span>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-panel="tracker">ÂèéÈõÜÁÆ°ÁêÜ</button>
      <button class="tab" data-panel="bulk">‰∏ÄÊã¨Ê§úÁ¥¢</button>
      <button class="tab" data-panel="sell">Â£≤Âç¥Âà§ÂÆö</button>
    </div>

    <!-- ÂèéÈõÜÁÆ°ÁêÜ -->
    <div class="panel active" id="panel-tracker">
      <div class="controls">
        <div class="search-box">
          <input type="text" id="search" placeholder="„Ç¢„Ç§„ÉÜ„É†Âêç„ÅßÊ§úÁ¥¢...">
        </div>
        <select id="filter">
          <option value="all">„Åô„Åπ„Å¶</option>
          <option value="incomplete">Êú™ÂÆå‰∫Ü</option>
          <option value="quest">„ÇØ„Ç®„Çπ„Éà„ÅÆ„Åø</option>
          <option value="hideout">„Éè„Ç§„Éâ„Ç¢„Ç¶„Éà„ÅÆ„Åø</option>
          <option value="sell-ok">Â£≤Âç¥OK</option>
          <option value="keep">Ë¶Å‰øùÊåÅ</option>
        </select>
        <select id="sort">
          <option value="priority">ÈÄ≤Ë°åÈ†Ü</option>
          <option value="slot-value">„Éû„ÇπÂçò‰æ°È†Ü</option>
          <option value="required">ÂøÖË¶ÅÊï∞È†Ü</option>
        </select>
        <button class="primary" id="btn-fetch">„Éá„Éº„ÇøÂèñÂæó</button>
        <span class="api-badge" id="api-status">Êú™ÂèñÂæó</span>
      </div>

      <div class="item-grid" id="item-grid"></div>
    </div>

    <!-- ‰∏ÄÊã¨Ê§úÁ¥¢ -->
    <div class="panel" id="panel-bulk">
      <div class="bulk-panel">
        <h3>„Ç¢„Ç§„ÉÜ„É†Âêç‰∏ÄÊã¨Ê§úÁ¥¢</h3>
        <textarea id="bulk-input" placeholder="„Ç¢„Ç§„ÉÜ„É†Âêç„Çí1Ë°å„Åö„Å§ÂÖ•ÂäõÔºàÈÉ®ÂàÜ‰∏ÄËá¥OKÔºâ&#10;&#10;‰æã:&#10;flash drive&#10;salewa&#10;morphine"></textarea>
        <div class="bulk-actions">
          <button class="primary" onclick="bulkSearch()">Ê§úÁ¥¢</button>
          <button onclick="clearBulk()">„ÇØ„É™„Ç¢</button>
          <span style="color:var(--text-muted); font-size:0.85rem;">OCR„ÅßË™≠„ÅøÂèñ„Å£„Åü„É™„Çπ„Éà„ÇíË≤º„Çä‰ªò„Åë</span>
        </div>
      </div>
      <div id="bulk-results"></div>
    </div>

    <!-- Â£≤Âç¥Âà§ÂÆö -->
    <div class="panel" id="panel-sell">
      <div class="summary-grid">
        <div class="summary-card">
          <h3 class="green">Â£≤Âç¥OKÔºà„Éû„ÇπÂçò‰æ°È†ÜÔºâ</h3>
          <div class="summary-items" id="list-sell"></div>
        </div>
        <div class="summary-card">
          <h3 class="yellow">Ë¶Å‰øùÊåÅÔºà„ÇØ„É©„Éï„Éà/„Éê„Éº„Çø„ÉºÁî®Ôºâ</h3>
          <div class="summary-items" id="list-keep"></div>
        </div>
      </div>
      <div class="summary-card">
        <h3 class="red">Ê∫ú„ÇÅ„Å®„Åë„É™„Çπ„ÉàÔºàÂ§ßÈáèÂøÖË¶ÅÔºâ</h3>
        <div class="summary-items" id="list-stockpile"></div>
      </div>
    </div>

    <footer>
      „Éá„Éº„Çø: <a href="https://tarkov.dev/api/" target="_blank">tarkov.dev API</a> |
      ÈÄ≤Êçó„ÅØCookie„Å´‰øùÂ≠ò | „Éè„Ç§„Éâ„Ç¢„Ç¶„ÉàFiRÂØæÂøú
    </footer>
  </div>

  <script>
    // Embedded base data (quest FiR items from static source)
    const BASE_DATA = PLACEHOLDER_DATA;

    // ============================================
    // State
    // ============================================
    let allItems = {};       // Merged quest + hideout FiR items
    let progress = {};       // User progress
    let priceData = {};      // Price info
    let barterItems = {};    // Used in barters
    let craftItems = {};     // Used in crafts
    let hideoutFirItems = {}; // Hideout FiR requirements
    let apiLoaded = false;

    // ============================================
    // Cookie Storage
    // ============================================
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }
    function setCookie(name, value, days = 365) {
      document.cookie = `${name}=${value}; expires=${new Date(Date.now() + days * 864e5).toUTCString()}; path=/; SameSite=Lax`;
    }
    function loadProgress() {
      const saved = getCookie('tarkov_fir_v2');
      if (saved) {
        try { progress = JSON.parse(decodeURIComponent(saved)); } catch(e) { progress = {}; }
      }
    }
    function saveProgress() {
      setCookie('tarkov_fir_v2', encodeURIComponent(JSON.stringify(progress)));
    }

    // ============================================
    // Initialize Items from Base Data
    // ============================================
    function initFromBaseData() {
      // Copy quest FiR items
      Object.entries(BASE_DATA.items || {}).forEach(([id, item]) => {
        allItems[id] = {
          id,
          name: item.name,
          nameShort: item.nameShort,
          type: item.type,
          totalRequired: item.totalRequired,
          sources: item.questBreakdown.map(q => ({
            type: 'quest',
            name: q.questName,
            count: q.count,
            dealer: q.dealer,
            level: q.level,
            depth: q.depth,
            priority: q.priority,
            kappa: q.kappa
          })),
          canCraft: item.canCraft,
          earliestLevel: item.earliestAccess?.level || 99,
          earliestPriority: item.earliestAccess?.priority || 999
        };
      });
    }

    // ============================================
    // Fetch from tarkov.dev API
    // ============================================
    async function fetchAllData() {
      const btn = document.getElementById('btn-fetch');
      const status = document.getElementById('api-status');

      btn.classList.add('loading');
      btn.disabled = true;
      status.textContent = 'ÂèñÂæó‰∏≠...';
      status.className = 'api-badge loading';

      const query = `{
        items {
          id name shortName
          avg24hPrice low24hPrice changeLast48hPercent
          width height
        }
        barters {
          requiredItems { item { name } count }
        }
        crafts {
          requiredItems { item { name } count }
        }
        hideoutStations {
          name
          levels {
            level
            itemRequirements {
              item { id name shortName }
              count
              attributes { name value }
            }
          }
        }
      }`;

      try {
        const res = await fetch('https://api.tarkov.dev/graphql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (json.errors) throw new Error(json.errors[0].message);

        const data = json.data;

        // Price lookup
        const priceByName = {};
        data.items.forEach(item => {
          const key = item.name.toLowerCase();
          priceByName[key] = item;
          if (item.shortName) priceByName[item.shortName.toLowerCase()] = item;
        });

        // Match prices to our items
        Object.values(allItems).forEach(item => {
          const match = priceByName[item.name.toLowerCase()] ||
                        priceByName[(item.nameShort || '').toLowerCase()];
          if (match) {
            const slots = (match.width || 1) * (match.height || 1);
            priceData[item.id] = {
              avg: match.avg24hPrice,
              low: match.low24hPrice,
              change: match.changeLast48hPercent,
              slots,
              perSlot: match.avg24hPrice ? Math.round(match.avg24hPrice / slots) : 0
            };
          }
        });

        // Barter items
        barterItems = {};
        data.barters.forEach(b => {
          b.requiredItems.forEach(r => {
            barterItems[r.item.name.toLowerCase()] = true;
          });
        });

        // Craft items
        craftItems = {};
        data.crafts.forEach(c => {
          c.requiredItems.forEach(r => {
            craftItems[r.item.name.toLowerCase()] = true;
          });
        });

        // Hideout FiR requirements
        hideoutFirItems = {};
        data.hideoutStations.forEach(station => {
          station.levels.forEach(level => {
            level.itemRequirements.forEach(req => {
              // Check if FiR required
              const isFir = req.attributes?.some(a =>
                a.name === 'foundInRaid' && a.value === 'true'
              );

              if (isFir) {
                const itemName = req.item.name;
                const key = itemName.toLowerCase().replace(/[^a-z0-9]/g, '_');

                if (!hideoutFirItems[key]) {
                  hideoutFirItems[key] = {
                    id: `hideout_${key}`,
                    name: itemName,
                    nameShort: req.item.shortName,
                    type: 'Hideout',
                    totalRequired: 0,
                    sources: [],
                    canCraft: false,
                    earliestLevel: 99,
                    earliestPriority: 999
                  };
                }

                hideoutFirItems[key].totalRequired += req.count;
                hideoutFirItems[key].sources.push({
                  type: 'hideout',
                  name: `${station.name} Lv${level.level}`,
                  count: req.count,
                  stationLevel: level.level,
                  priority: level.level * 10
                });

                // Update earliest
                if (level.level < hideoutFirItems[key].earliestLevel) {
                  hideoutFirItems[key].earliestLevel = level.level;
                  hideoutFirItems[key].earliestPriority = level.level * 10;
                }
              }
            });
          });
        });

        // Merge hideout FiR items into allItems
        Object.values(hideoutFirItems).forEach(hItem => {
          // Check if already exists (by name match)
          const existingKey = Object.keys(allItems).find(k =>
            allItems[k].name.toLowerCase() === hItem.name.toLowerCase()
          );

          if (existingKey) {
            // Merge sources
            allItems[existingKey].sources.push(...hItem.sources);
            allItems[existingKey].totalRequired += hItem.totalRequired;
          } else {
            // Add new item
            allItems[hItem.id] = hItem;

            // Try to get price
            const match = priceByName[hItem.name.toLowerCase()];
            if (match) {
              const slots = (match.width || 1) * (match.height || 1);
              priceData[hItem.id] = {
                avg: match.avg24hPrice,
                low: match.low24hPrice,
                change: match.changeLast48hPercent,
                slots,
                perSlot: match.avg24hPrice ? Math.round(match.avg24hPrice / slots) : 0
              };
            }
          }
        });

        apiLoaded = true;
        status.textContent = `ÂÆå‰∫Ü (${Object.keys(hideoutFirItems).length} hideout FiR)`;
        status.className = 'api-badge ok';

        renderAll();

      } catch (err) {
        console.error(err);
        status.textContent = `„Ç®„É©„Éº: ${err.message}`;
        status.className = 'api-badge error';
      } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }

    // ============================================
    // Progress Management
    // ============================================
    function getCollected(itemId) {
      return progress[itemId] || 0;
    }
    function setCollected(itemId, count) {
      const item = allItems[itemId];
      if (!item) return;
      count = Math.max(0, Math.min(count, item.totalRequired));
      if (count === 0) delete progress[itemId];
      else progress[itemId] = count;
      saveProgress();
      renderAll();
    }

    // ============================================
    // Item Status
    // ============================================
    function getItemStatus(itemId) {
      const item = allItems[itemId];
      const collected = getCollected(itemId);
      if (collected < item.totalRequired) {
        return { status: 'need', label: 'ÂèéÈõÜ‰∏≠' };
      }
      const nameLower = item.name.toLowerCase();
      if (craftItems[nameLower] || barterItems[nameLower]) {
        return { status: 'keep', label: 'Ë¶Å‰øùÊåÅ', reason: craftItems[nameLower] ? 'Craft' : 'Barter' };
      }
      return { status: 'sell', label: 'Â£≤Âç¥OK' };
    }

    // ============================================
    // Formatting
    // ============================================
    function formatPrice(p) {
      if (!p) return '-';
      if (p >= 1000000) return (p / 1000000).toFixed(1) + 'M';
      if (p >= 1000) return Math.round(p / 1000) + 'K';
      return p.toString();
    }

    function getSourceClass(source) {
      if (source.type === 'quest') {
        const lvl = source.level || 99;
        if (lvl <= 15) return 'quest-early';
        if (lvl <= 30) return 'quest-mid';
        return 'quest-late';
      } else {
        const lvl = source.stationLevel || 9;
        if (lvl <= 1) return 'hideout-early';
        if (lvl <= 2) return 'hideout-mid';
        return 'hideout-late';
      }
    }

    // ============================================
    // Rendering
    // ============================================
    function renderAll() {
      renderStats();
      renderItems();
      renderSellLists();
    }

    function renderStats() {
      let total = 0, collected = 0, complete = 0, sellable = 0;
      Object.values(allItems).forEach(item => {
        total += item.totalRequired;
        const c = getCollected(item.id);
        collected += Math.min(c, item.totalRequired);
        if (c >= item.totalRequired) {
          complete++;
          if (getItemStatus(item.id).status === 'sell') sellable++;
        }
      });
      document.getElementById('stat-progress').textContent = `${collected}/${total}`;
      document.getElementById('stat-complete').textContent = complete;
      document.getElementById('stat-sellable').textContent = sellable;
    }

    function renderItems() {
      const search = document.getElementById('search').value.toLowerCase();
      const filter = document.getElementById('filter').value;
      const sort = document.getElementById('sort').value;

      let items = Object.values(allItems).map(item => ({
        ...item,
        collected: getCollected(item.id),
        price: priceData[item.id],
        itemStatus: getItemStatus(item.id)
      }));

      // Filter
      items = items.filter(item => {
        if (search && !item.name.toLowerCase().includes(search)) return false;
        const isComplete = item.collected >= item.totalRequired;
        const hasQuest = item.sources.some(s => s.type === 'quest');
        const hasHideout = item.sources.some(s => s.type === 'hideout');

        switch (filter) {
          case 'incomplete': return !isComplete;
          case 'quest': return hasQuest;
          case 'hideout': return hasHideout;
          case 'sell-ok': return item.itemStatus.status === 'sell';
          case 'keep': return item.itemStatus.status === 'keep';
          default: return true;
        }
      });

      // Sort
      items.sort((a, b) => {
        switch (sort) {
          case 'priority': return a.earliestPriority - b.earliestPriority;
          case 'slot-value': return (b.price?.perSlot || 0) - (a.price?.perSlot || 0);
          case 'required': return b.totalRequired - a.totalRequired;
          default: return 0;
        }
      });

      const grid = document.getElementById('item-grid');
      if (items.length === 0) {
        grid.innerHTML = '<div class="empty-state">Ë©≤ÂΩì„Åô„Çã„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }

      grid.innerHTML = items.map(item => {
        const isComplete = item.collected >= item.totalRequired;
        const isPartial = item.collected > 0 && !isComplete;
        const hasHideout = item.sources.some(s => s.type === 'hideout');

        // Sort sources by priority (earliest first = left)
        const sortedSources = [...item.sources].sort((a, b) => (a.priority || 999) - (b.priority || 999));

        // Source tags (left = early, right = late)
        const sourceTags = sortedSources.slice(0, 4).map(s => {
          const cls = getSourceClass(s);
          const icon = s.type === 'quest' ? '' : 'üè†';
          return `<span class="source-tag ${cls}">${icon}${s.name} x${s.count}</span>`;
        }).join('');
        const moreSources = sortedSources.length > 4 ? `<span class="source-tag">+${sortedSources.length - 4}</span>` : '';

        // Extra tags
        let tags = '';
        if (item.canCraft) tags += '<span class="tag craft">CraftÂèØ</span>';
        if (barterItems[item.name.toLowerCase()]) tags += '<span class="tag barter">BarterÁ¥†Êùê</span>';
        if (craftItems[item.name.toLowerCase()]) tags += '<span class="tag craft">CraftÁ¥†Êùê</span>';

        // Price
        const priceHtml = item.price
          ? `<div class="item-price"><div class="main">${formatPrice(item.price.avg)}</div><div class="per-slot">${formatPrice(item.price.perSlot)}/slot</div></div>`
          : '<div class="item-price"><div class="main">-</div></div>';

        // Status
        const statusHtml = `<div class="item-status"><span class="status-badge ${item.itemStatus.status}">${item.itemStatus.label}</span></div>`;

        return `
          <div class="item-row ${isComplete ? 'complete' : ''} ${isPartial ? 'partial' : ''} ${hasHideout && !isComplete ? 'hideout' : ''}">
            <div class="item-info">
              <h3>${item.name}</h3>
              <div class="item-tags">${sourceTags}${moreSources}${tags}</div>
            </div>
            ${priceHtml}
            ${statusHtml}
            <div class="item-counter">
              <button onclick="setCollected('${item.id}', ${item.collected - 1})">-</button>
              <input type="number" value="${item.collected}" min="0" max="${item.totalRequired}"
                onchange="setCollected('${item.id}', parseInt(this.value)||0)">
              <button onclick="setCollected('${item.id}', ${item.collected + 1})">+</button>
            </div>
            <div class="item-progress ${isComplete ? 'done' : ''}">${item.collected}/${item.totalRequired}</div>
          </div>
        `;
      }).join('');
    }

    function renderSellLists() {
      const sellItems = [];
      const keepItems = [];
      const stockpileItems = [];

      Object.values(allItems).forEach(item => {
        const collected = getCollected(item.id);
        const isComplete = collected >= item.totalRequired;
        const status = getItemStatus(item.id);
        const price = priceData[item.id];

        if (isComplete && status.status === 'sell') {
          sellItems.push({ item, price });
        } else if (isComplete && status.status === 'keep') {
          keepItems.push({ item, price, reason: status.reason });
        }

        if (item.totalRequired >= 4 || item.sources.length >= 2) {
          stockpileItems.push({ item, collected, price });
        }
      });

      sellItems.sort((a, b) => (b.price?.perSlot || 0) - (a.price?.perSlot || 0));
      keepItems.sort((a, b) => (b.price?.perSlot || 0) - (a.price?.perSlot || 0));
      stockpileItems.sort((a, b) => b.item.totalRequired - a.item.totalRequired);

      document.getElementById('list-sell').innerHTML = sellItems.length === 0
        ? '<div class="empty-state">„Å™„Åó</div>'
        : sellItems.map(({ item, price }) => `
            <div class="summary-item">
              <span class="name">${item.name}</span>
              <span class="price">${price ? formatPrice(price.perSlot) + '/slot' : '-'}</span>
            </div>
          `).join('');

      document.getElementById('list-keep').innerHTML = keepItems.length === 0
        ? '<div class="empty-state">„Å™„Åó</div>'
        : keepItems.map(({ item, price, reason }) => `
            <div class="summary-item">
              <span><span class="name">${item.name}</span> <span class="meta">(${reason})</span></span>
              <span class="price">${price ? formatPrice(price.avg) : '-'}</span>
            </div>
          `).join('');

      document.getElementById('list-stockpile').innerHTML = stockpileItems.slice(0, 30).map(({ item, collected, price }) => {
        const remain = item.totalRequired - collected;
        return `
          <div class="summary-item">
            <span><span class="name">${item.name}</span> <span class="meta">${collected}/${item.totalRequired}${remain > 0 ? ` („ÅÇ„Å®${remain})` : ' ‚úì'}</span></span>
            <span class="price">${price ? formatPrice(price.avg) : '-'}</span>
          </div>
        `;
      }).join('');
    }

    // ============================================
    // Bulk Search
    // ============================================
    function bulkSearch() {
      const input = document.getElementById('bulk-input').value;
      const terms = input.split('\n').map(s => s.trim().toLowerCase()).filter(s => s);

      if (terms.length === 0) {
        document.getElementById('bulk-results').innerHTML = '<div class="empty-state">Ê§úÁ¥¢Ë™û„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
        return;
      }

      const results = [];
      Object.values(allItems).forEach(item => {
        const nameLower = item.name.toLowerCase();
        const matched = terms.filter(t => nameLower.includes(t));
        if (matched.length > 0) {
          results.push({ item, matched, collected: getCollected(item.id) });
        }
      });

      const needed = results.filter(r => r.collected < r.item.totalRequired);
      const found = results.filter(r => r.collected >= r.item.totalRequired);

      let html = `<p style="margin-bottom:16px;">Ê§úÁ¥¢ÁµêÊûú: ${results.length}‰ª∂</p>`;

      if (needed.length > 0) {
        html += `<div class="summary-card"><h3 class="red">„Åæ„Å†ÂøÖË¶Å (${needed.length})</h3><div class="summary-items">`;
        needed.forEach(r => {
          const price = priceData[r.item.id];
          html += `<div class="summary-item"><span><span class="name">${r.item.name}</span> <span class="meta">${r.collected}/${r.item.totalRequired}</span></span><span class="price">${price ? formatPrice(price.avg) : '-'}</span></div>`;
        });
        html += '</div></div>';
      }

      if (found.length > 0) {
        html += `<div class="summary-card" style="margin-top:16px;"><h3 class="green">ÂèéÈõÜÂÆå‰∫Ü (${found.length})</h3><div class="summary-items">`;
        found.forEach(r => {
          const status = getItemStatus(r.item.id);
          html += `<div class="summary-item"><span class="name">${r.item.name}</span><span class="status-badge ${status.status}">${status.label}</span></div>`;
        });
        html += '</div></div>';
      }

      if (results.length === 0) {
        html = '<div class="empty-state">‰∏ÄËá¥„Åô„Çã„Ç¢„Ç§„ÉÜ„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
      }

      document.getElementById('bulk-results').innerHTML = html;
    }

    function clearBulk() {
      document.getElementById('bulk-input').value = '';
      document.getElementById('bulk-results').innerHTML = '';
    }

    // ============================================
    // Reset
    // ============================================
    function resetProgress() {
      if (confirm('„Åô„Åπ„Å¶„ÅÆÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
        progress = {};
        saveProgress();
        renderAll();
      }
    }

    // ============================================
    // Tab Navigation
    // ============================================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.panel).classList.add('active');
      });
    });

    // ============================================
    // Event Listeners
    // ============================================
    document.getElementById('search').addEventListener('input', renderItems);
    document.getElementById('filter').addEventListener('change', renderItems);
    document.getElementById('sort').addEventListener('change', renderItems);
    document.getElementById('btn-fetch').addEventListener('click', fetchAllData);

    // ============================================
    // Initialize
    // ============================================
    loadProgress();
    initFromBaseData();
    renderAll();

    // Auto-fetch on load
    fetchAllData();
  </script>
</body>
</html>
