<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarkov FiR Tracker</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: #ffa500; margin-bottom: 5px; }
    .subtitle { color: #888; margin-bottom: 20px; }

    .tabs {
      display: flex; gap: 5px; margin-bottom: 15px;
    }
    .tab {
      padding: 10px 20px;
      background: #2a2a2a;
      border: 1px solid #444;
      cursor: pointer;
    }
    .tab.active { background: #ffa500; color: #000; border-color: #ffa500; }
    .tab:hover:not(.active) { background: #3a3a3a; }

    .panel { display: none; }
    .panel.active { display: block; }

    .stats {
      background: #2a2a2a;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 4px solid #ffa500;
    }
    .stats-row { display: flex; gap: 20px; flex-wrap: wrap; }
    .stat-value { color: #ffa500; font-weight: bold; }

    .controls {
      display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;
    }
    input[type="text"], input[type="number"], textarea {
      background: #2a2a2a;
      border: 1px solid #444;
      color: #e0e0e0;
      padding: 8px 12px;
      font-family: inherit;
    }
    #search { flex: 1; min-width: 200px; }
    select, button {
      background: #2a2a2a;
      border: 1px solid #444;
      color: #e0e0e0;
      padding: 8px 12px;
      font-family: inherit;
      cursor: pointer;
    }
    button:hover { background: #3a3a3a; }
    button.primary { background: #006400; }
    button.primary:hover { background: #008000; }
    button.danger { background: #8b0000; }
    button.danger:hover { background: #a00000; }
    button.loading { opacity: 0.5; cursor: wait; }

    .bulk-search {
      margin-bottom: 20px;
      background: #2a2a2a;
      padding: 15px;
      border-left: 4px solid #00bfff;
    }
    .bulk-search textarea {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
      resize: vertical;
    }
    .bulk-search-info { font-size: 0.85em; color: #888; }

    .item-list { }
    .item {
      background: #2a2a2a;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #444;
      display: grid;
      grid-template-columns: 55px 1fr 90px 100px 90px 70px;
      align-items: center;
      gap: 10px;
    }
    .item.complete { border-left-color: #00ff00; }
    .item.partial { border-left-color: #ffff00; }
    .item.sell-ok { background: #1a2a1a; }
    .item.keep { background: #2a2a1a; }

    .item-level {
      background: #333;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      text-align: center;
    }
    .item-level.early { background: #006400; color: #90ee90; }
    .item-level.mid { background: #8b8000; color: #ffff90; }
    .item-level.late { background: #8b0000; color: #ff9090; }

    .item-name { min-width: 150px; }
    .item-name strong { color: #fff; }
    .item-meta { font-size: 0.8em; color: #888; display: flex; gap: 8px; flex-wrap: wrap; }
    .badge {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 0.75em;
    }
    .badge.craft { background: #003366; color: #66b3ff; }
    .badge.barter { background: #4a3000; color: #ffcc00; }
    .badge.keep { background: #4a4a00; color: #ffff66; }
    .badge.sell { background: #004a00; color: #66ff66; }

    .item-price {
      font-size: 0.85em;
      text-align: right;
    }
    .price-main { color: #00bfff; }
    .price-per-slot { color: #888; font-size: 0.8em; }
    .price-change { font-size: 0.75em; }
    .price-change.up { color: #ff4444; }
    .price-change.down { color: #44ff44; }

    .item-status {
      text-align: center;
      font-size: 0.8em;
      padding: 4px;
      border-radius: 4px;
    }
    .item-status.sell-ok { background: #004400; color: #44ff44; }
    .item-status.keep { background: #444400; color: #ffff44; }
    .item-status.need { background: #440000; color: #ff4444; }

    .item-count {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .item-count input {
      width: 45px;
      text-align: center;
      padding: 5px;
    }
    .item-count button { padding: 5px 8px; }

    .item-progress { text-align: right; }
    .item-progress.done { color: #00ff00; }

    .quests {
      font-size: 0.75em;
      color: #888;
      margin-top: 5px;
      grid-column: 1 / -1;
    }
    .quest-tag {
      display: inline-block;
      background: #333;
      padding: 2px 5px;
      margin: 2px;
      border-radius: 3px;
    }
    .quest-tag.kappa { border: 1px solid #ffa500; }

    .api-status {
      font-size: 0.85em;
      padding: 5px 10px;
      border-radius: 4px;
    }
    .api-status.ok { background: #1a3a1a; color: #90ee90; }
    .api-status.error { background: #3a1a1a; color: #ff9090; }
    .api-status.loading { background: #3a3a1a; color: #ffff90; }

    .summary-section {
      background: #2a2a2a;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #00bfff;
    }
    .summary-section h3 { color: #00bfff; margin-bottom: 10px; }
    .summary-list { display: flex; flex-wrap: wrap; gap: 10px; }
    .summary-item {
      background: #333;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .summary-item .count { color: #ffa500; }
    .summary-item .price { color: #00bfff; font-size: 0.85em; }

    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #333;
      font-size: 0.85em;
      color: #666;
    }
    .footer a { color: #ffa500; }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tarkov FiR Tracker</h1>
    <p class="subtitle">ズボラ向けFiRアイテム管理 - 売っていいか一目でわかる</p>

    <div class="tabs">
      <div class="tab active" data-panel="tracker">収集管理</div>
      <div class="tab" data-panel="bulk">一括検索</div>
      <div class="tab" data-panel="sellable">売却判定</div>
    </div>

    <!-- 収集管理パネル -->
    <div class="panel active" id="panel-tracker">
      <div class="stats">
        <div class="stats-row">
          <div class="stat">進捗: <span class="stat-value" id="progress">0/0</span></div>
          <div class="stat">完了: <span class="stat-value" id="completed-items">0/0</span></div>
          <div class="stat">売却可: <span class="stat-value" id="sellable-count">0</span></div>
          <div class="stat"><span class="api-status" id="api-status">価格未取得</span></div>
        </div>
      </div>

      <div class="controls">
        <input type="text" id="search" placeholder="アイテム名で検索...">
        <select id="filter">
          <option value="all">すべて</option>
          <option value="incomplete">未完了</option>
          <option value="sell-ok">売却OK</option>
          <option value="keep">要保持</option>
          <option value="craft-later">Craft後回し</option>
        </select>
        <select id="sort">
          <option value="priority">進行順</option>
          <option value="level">レベル順</option>
          <option value="slot-value-desc">マス単価 高い順</option>
          <option value="required-desc">必要数 多い順</option>
        </select>
        <button class="primary" id="fetch-prices">価格取得</button>
        <button class="danger" onclick="resetProgress()">リセット</button>
      </div>

      <div class="item-list" id="item-list"></div>
    </div>

    <!-- 一括検索パネル -->
    <div class="panel" id="panel-bulk">
      <div class="bulk-search">
        <h3 style="margin-bottom:10px; color:#00bfff;">アイテム名一括検索</h3>
        <textarea id="bulk-input" placeholder="アイテム名を1行ずつ入力（部分一致OK）&#10;例:&#10;flash drive&#10;salewa&#10;morphine"></textarea>
        <button class="primary" onclick="bulkSearch()">検索</button>
        <button onclick="clearBulkSearch()">クリア</button>
        <span class="bulk-search-info">OCRで読み取ったアイテムリストを貼り付けて検索</span>
      </div>
      <div id="bulk-results"></div>
    </div>

    <!-- 売却判定パネル -->
    <div class="panel" id="panel-sellable">
      <div class="summary-section">
        <h3>今すぐ売却OK（マス単価順）</h3>
        <p style="font-size:0.85em; color:#888; margin-bottom:10px;">収集完了 + クラフト/バーター不要</p>
        <div class="summary-list" id="sell-ok-list"></div>
      </div>

      <div class="summary-section" style="border-left-color:#ffcc00;">
        <h3 style="color:#ffcc00;">要保持（クラフト/バーター用途あり）</h3>
        <p style="font-size:0.85em; color:#888; margin-bottom:10px;">収集完了だがハイドアウトで使う可能性あり</p>
        <div class="summary-list" id="keep-list"></div>
      </div>

      <div class="summary-section" style="border-left-color:#ff6666;">
        <h3 style="color:#ff6666;">とりあえず溜めとけリスト</h3>
        <p style="font-size:0.85em; color:#888; margin-bottom:10px;">複数クエストで必要 or 大量に必要なアイテム</p>
        <div class="summary-list" id="stockpile-list"></div>
      </div>
    </div>

    <div class="footer">
      <p>データ: <a href="https://github.com/TarkovTracker/tarkovdata" target="_blank">TarkovTracker</a> | 価格: <a href="https://tarkov.dev/api/" target="_blank">tarkov.dev API</a></p>
      <p>進捗はCookieに保存 | バーター/クラフト情報はAPI取得時に更新</p>
    </div>
  </div>

  <script>
    const FIR_DATA = PLACEHOLDER_DATA;

    // ============================================
    // State
    // ============================================
    let progress = {};
    let priceData = {};
    let barterData = {};  // Items used in barters
    let craftData = {};   // Items used in crafts
    let bulkSearchTerms = [];

    // ============================================
    // Cookie Storage
    // ============================================
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, days = 365) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
    }

    function loadProgress() {
      const saved = getCookie('tarkov_fir_progress');
      if (saved) {
        try {
          progress = JSON.parse(decodeURIComponent(saved));
        } catch (e) {
          progress = {};
        }
      }
    }

    function saveProgress() {
      setCookie('tarkov_fir_progress', encodeURIComponent(JSON.stringify(progress)));
    }

    function getCollected(itemId) {
      return progress[itemId] || 0;
    }

    function setCollected(itemId, count) {
      const item = FIR_DATA.items[itemId];
      if (!item) return;
      count = Math.max(0, Math.min(count, item.totalRequired));
      if (count === 0) {
        delete progress[itemId];
      } else {
        progress[itemId] = count;
      }
      saveProgress();
      updateAll();
    }

    // ============================================
    // Sell/Keep Status
    // ============================================
    function getItemStatus(itemId) {
      const item = FIR_DATA.items[itemId];
      const collected = getCollected(itemId);
      const isComplete = collected >= item.totalRequired;

      if (!isComplete) {
        return { status: 'need', label: '収集中', class: 'need' };
      }

      // Check if used in crafts or barters
      const usedInCraft = craftData[item.name?.toLowerCase()];
      const usedInBarter = barterData[item.name?.toLowerCase()];
      const canCraft = item.canCraft;

      if (usedInCraft || usedInBarter) {
        return { status: 'keep', label: '要保持', class: 'keep', reason: usedInCraft ? 'Craft素材' : 'Barter素材' };
      }

      return { status: 'sell-ok', label: '売却OK', class: 'sell-ok' };
    }

    // ============================================
    // Price Fetching
    // ============================================
    async function fetchPrices() {
      const btn = document.getElementById('fetch-prices');
      const status = document.getElementById('api-status');

      btn.classList.add('loading');
      btn.disabled = true;
      status.textContent = '価格取得中...';
      status.className = 'api-status loading';

      const query = `
        query {
          items {
            id
            name
            shortName
            avg24hPrice
            low24hPrice
            changeLast48hPercent
            width
            height
            iconLink
          }
          barters {
            requiredItems {
              item { name }
              count
            }
          }
          crafts {
            requiredItems {
              item { name }
              count
            }
          }
        }
      `;

      try {
        const response = await fetch('https://api.tarkov.dev/graphql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (data.errors) throw new Error(data.errors[0].message);

        // Build price lookup
        const priceByName = {};
        data.data.items.forEach(item => {
          priceByName[item.name.toLowerCase()] = item;
          priceByName[item.shortName.toLowerCase()] = item;
        });

        // Match to our items
        Object.entries(FIR_DATA.items).forEach(([id, item]) => {
          const match = priceByName[item.name.toLowerCase()] ||
                        priceByName[item.nameShort?.toLowerCase()];
          if (match) {
            const slots = (match.width || 1) * (match.height || 1);
            priceData[id] = {
              avg: match.avg24hPrice,
              low: match.low24hPrice,
              change: match.changeLast48hPercent,
              width: match.width || 1,
              height: match.height || 1,
              slots: slots,
              perSlot: match.avg24hPrice ? Math.round(match.avg24hPrice / slots) : 0,
              icon: match.iconLink
            };
          }
        });

        // Build barter usage lookup
        barterData = {};
        data.data.barters.forEach(barter => {
          barter.requiredItems.forEach(req => {
            barterData[req.item.name.toLowerCase()] = true;
          });
        });

        // Build craft usage lookup
        craftData = {};
        data.data.crafts.forEach(craft => {
          craft.requiredItems.forEach(req => {
            craftData[req.item.name.toLowerCase()] = true;
          });
        });

        status.textContent = `価格取得完了 (${Object.keys(priceData).length}件)`;
        status.className = 'api-status ok';
        updateAll();

      } catch (err) {
        console.error('Price fetch error:', err);
        status.textContent = `エラー: ${err.message}`;
        status.className = 'api-status error';
      } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }

    function formatPrice(price) {
      if (!price) return '-';
      if (price >= 1000000) return (price / 1000000).toFixed(1) + 'M';
      if (price >= 1000) return Math.round(price / 1000) + 'K';
      return price.toString();
    }

    // ============================================
    // Bulk Search
    // ============================================
    function bulkSearch() {
      const input = document.getElementById('bulk-input').value;
      bulkSearchTerms = input.split('\n')
        .map(s => s.trim().toLowerCase())
        .filter(s => s.length > 0);

      if (bulkSearchTerms.length === 0) {
        document.getElementById('bulk-results').innerHTML = '<p style="color:#888;">検索語を入力してください</p>';
        return;
      }

      const results = [];
      Object.entries(FIR_DATA.items).forEach(([id, item]) => {
        const nameLower = item.name.toLowerCase();
        const matched = bulkSearchTerms.filter(term => nameLower.includes(term));
        if (matched.length > 0) {
          results.push({ id, item, matched, collected: getCollected(id) });
        }
      });

      renderBulkResults(results);
    }

    function clearBulkSearch() {
      document.getElementById('bulk-input').value = '';
      bulkSearchTerms = [];
      document.getElementById('bulk-results').innerHTML = '';
    }

    function renderBulkResults(results) {
      const container = document.getElementById('bulk-results');

      if (results.length === 0) {
        container.innerHTML = '<p style="color:#ff6666;">一致するアイテムが見つかりませんでした</p>';
        return;
      }

      // Group by match status
      const found = results.filter(r => r.collected >= r.item.totalRequired);
      const needed = results.filter(r => r.collected < r.item.totalRequired);

      let html = `<p style="margin-bottom:15px;">検索結果: ${results.length}件</p>`;

      if (needed.length > 0) {
        html += `<div class="summary-section" style="border-left-color:#ff6666;">
          <h3 style="color:#ff6666;">まだ必要 (${needed.length})</h3>
          <div class="summary-list">`;
        needed.forEach(r => {
          const price = priceData[r.id];
          html += `<div class="summary-item">
            <strong>${r.item.name}</strong><br>
            <span class="count">${r.collected}/${r.item.totalRequired}</span>
            ${price ? `<span class="price">${formatPrice(price.avg)}</span>` : ''}
          </div>`;
        });
        html += '</div></div>';
      }

      if (found.length > 0) {
        html += `<div class="summary-section" style="border-left-color:#44ff44;">
          <h3 style="color:#44ff44;">収集完了 (${found.length})</h3>
          <div class="summary-list">`;
        found.forEach(r => {
          const status = getItemStatus(r.id);
          html += `<div class="summary-item">
            <strong>${r.item.name}</strong>
            <span class="badge ${status.class}">${status.label}</span>
          </div>`;
        });
        html += '</div></div>';
      }

      container.innerHTML = html;
    }

    // ============================================
    // Stats & Rendering
    // ============================================
    function updateStats() {
      let totalRequired = 0;
      let totalCollected = 0;
      let completedItems = 0;
      let sellableCount = 0;
      const itemCount = Object.keys(FIR_DATA.items).length;

      for (const [id, item] of Object.entries(FIR_DATA.items)) {
        totalRequired += item.totalRequired;
        const collected = getCollected(id);
        totalCollected += collected;
        if (collected >= item.totalRequired) {
          completedItems++;
          const status = getItemStatus(id);
          if (status.status === 'sell-ok') sellableCount++;
        }
      }

      document.getElementById('progress').textContent = `${totalCollected}/${totalRequired}`;
      document.getElementById('completed-items').textContent = `${completedItems}/${itemCount}`;
      document.getElementById('sellable-count').textContent = sellableCount;
    }

    function updateAll() {
      updateStats();
      renderItems();
      renderSellableLists();
    }

    function renderItems() {
      const search = document.getElementById('search').value.toLowerCase();
      const filter = document.getElementById('filter').value;
      const sort = document.getElementById('sort').value;

      let items = Object.entries(FIR_DATA.items).map(([id, item]) => ({
        id,
        ...item,
        collected: getCollected(id),
        price: priceData[id],
        itemStatus: getItemStatus(id)
      }));

      // Filter
      items = items.filter(item => {
        if (search && !item.name.toLowerCase().includes(search)) return false;

        const isComplete = item.collected >= item.totalRequired;
        if (filter === 'incomplete' && isComplete) return false;
        if (filter === 'sell-ok' && item.itemStatus.status !== 'sell-ok') return false;
        if (filter === 'keep' && item.itemStatus.status !== 'keep') return false;
        if (filter === 'craft-later' && !item.canCraft) return false;

        return true;
      });

      // Sort
      items.sort((a, b) => {
        switch (sort) {
          case 'priority':
            return (a.earliestAccess?.priority || 999) - (b.earliestAccess?.priority || 999);
          case 'level':
            return (a.earliestAccess?.level || 99) - (b.earliestAccess?.level || 99);
          case 'slot-value-desc':
            return (b.price?.perSlot || 0) - (a.price?.perSlot || 0);
          case 'required-desc':
            return b.totalRequired - a.totalRequired;
          default:
            return 0;
        }
      });

      const list = document.getElementById('item-list');
      list.innerHTML = items.map(item => {
        const isComplete = item.collected >= item.totalRequired;
        const isPartial = item.collected > 0 && !isComplete;
        const statusClass = item.itemStatus.status;
        const progressClass = isComplete ? 'done' : '';

        const level = item.earliestAccess?.level || '?';
        const levelClass = level <= 10 ? 'early' : level <= 25 ? 'mid' : 'late';

        // Badges
        let badges = '';
        if (item.canCraft) badges += '<span class="badge craft">Craft可</span>';
        if (barterData[item.name.toLowerCase()]) badges += '<span class="badge barter">Barter素材</span>';
        if (craftData[item.name.toLowerCase()]) badges += '<span class="badge craft">Craft素材</span>';

        // Price
        let priceHtml = '<div class="item-price">-</div>';
        if (item.price) {
          const changeClass = item.price.change > 0 ? 'up' : item.price.change < 0 ? 'down' : '';
          priceHtml = `
            <div class="item-price">
              <div class="price-main">${formatPrice(item.price.avg)}</div>
              <div class="price-per-slot">${formatPrice(item.price.perSlot)}/slot</div>
            </div>
          `;
        }

        // Status badge
        const statusBadge = isComplete
          ? `<div class="item-status ${item.itemStatus.class}">${item.itemStatus.label}</div>`
          : `<div class="item-status need">必要</div>`;

        // Quests
        const questTags = item.questBreakdown.slice(0, 3).map(q =>
          `<span class="quest-tag${q.kappa ? ' kappa' : ''}">Lv${q.level} ${q.questName} (${q.count})</span>`
        ).join('');
        const moreQuests = item.questBreakdown.length > 3 ? ` +${item.questBreakdown.length - 3}` : '';

        return `
          <div class="item ${isComplete ? statusClass : ''} ${isPartial ? 'partial' : ''}">
            <div class="item-level ${levelClass}">Lv${level}</div>
            <div class="item-name">
              <strong>${item.name}</strong>
              <div class="item-meta">${badges}</div>
            </div>
            ${priceHtml}
            ${statusBadge}
            <div class="item-count">
              <button onclick="setCollected('${item.id}', ${item.collected - 1})">-</button>
              <input type="number" value="${item.collected}" min="0" max="${item.totalRequired}"
                onchange="setCollected('${item.id}', parseInt(this.value) || 0)">
              <button onclick="setCollected('${item.id}', ${item.collected + 1})">+</button>
            </div>
            <div class="item-progress ${progressClass}">${item.collected}/${item.totalRequired}</div>
            <div class="quests">${questTags}${moreQuests}</div>
          </div>
        `;
      }).join('');
    }

    function renderSellableLists() {
      const sellOkItems = [];
      const keepItems = [];
      const stockpileItems = [];

      Object.entries(FIR_DATA.items).forEach(([id, item]) => {
        const collected = getCollected(id);
        const isComplete = collected >= item.totalRequired;
        const status = getItemStatus(id);
        const price = priceData[id];

        if (isComplete && status.status === 'sell-ok') {
          sellOkItems.push({ id, item, price });
        } else if (isComplete && status.status === 'keep') {
          keepItems.push({ id, item, price, reason: status.reason });
        }

        // Stockpile: multiple quests or high quantity needed
        if (item.questBreakdown.length >= 2 || item.totalRequired >= 5) {
          stockpileItems.push({ id, item, collected, price });
        }
      });

      // Sort by slot value
      sellOkItems.sort((a, b) => (b.price?.perSlot || 0) - (a.price?.perSlot || 0));
      keepItems.sort((a, b) => (b.price?.perSlot || 0) - (a.price?.perSlot || 0));
      stockpileItems.sort((a, b) => b.item.totalRequired - a.item.totalRequired);

      // Render sell-ok
      document.getElementById('sell-ok-list').innerHTML = sellOkItems.length === 0
        ? '<span style="color:#888;">なし（まだ収集完了アイテムがありません）</span>'
        : sellOkItems.map(({ item, price }) => `
            <div class="summary-item">
              <strong>${item.name}</strong><br>
              ${price ? `<span class="price">${formatPrice(price.avg)} (${formatPrice(price.perSlot)}/slot)</span>` : ''}
            </div>
          `).join('');

      // Render keep
      document.getElementById('keep-list').innerHTML = keepItems.length === 0
        ? '<span style="color:#888;">なし</span>'
        : keepItems.map(({ item, price, reason }) => `
            <div class="summary-item">
              <strong>${item.name}</strong> <span class="badge barter">${reason}</span><br>
              ${price ? `<span class="price">${formatPrice(price.avg)}</span>` : ''}
            </div>
          `).join('');

      // Render stockpile
      document.getElementById('stockpile-list').innerHTML = stockpileItems.slice(0, 20).map(({ id, item, collected, price }) => {
        const remaining = item.totalRequired - collected;
        const status = remaining > 0 ? `あと${remaining}個` : '完了';
        return `
          <div class="summary-item">
            <strong>${item.name}</strong><br>
            <span class="count">${collected}/${item.totalRequired}</span> ${status}
            ${price ? `<span class="price">${formatPrice(price.avg)}</span>` : ''}
          </div>
        `;
      }).join('');
    }

    function resetProgress() {
      if (confirm('すべての進捗をリセットしますか？')) {
        progress = {};
        saveProgress();
        updateAll();
      }
    }

    // ============================================
    // Tab Navigation
    // ============================================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.panel).classList.add('active');
      });
    });

    // ============================================
    // Event Listeners
    // ============================================
    document.getElementById('search').addEventListener('input', renderItems);
    document.getElementById('filter').addEventListener('change', renderItems);
    document.getElementById('sort').addEventListener('change', renderItems);
    document.getElementById('fetch-prices').addEventListener('click', fetchPrices);

    // ============================================
    // Initialize
    // ============================================
    loadProgress();
    updateAll();
  </script>
</body>
</html>
