<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarkov Item Lookup</title>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --muted: #8b949e;
      --accent: #f0883e;
      --green: #3fb950;
      --yellow: #d29922;
      --red: #f85149;
      --blue: #58a6ff;
      --bronze: #cd7f32;
      --silver: #c0c0c0;
      --gold: #ffd700;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 12px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 8px;
    }
    .header h1 { font-size: 1.2rem; color: var(--accent); }
    .header-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .header-controls button, .header-controls select {
      padding: 6px 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
    }
    .status { font-size: 0.8rem; color: var(--muted); }
    .status.ok { color: var(--green); }

    .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
    .tab {
      padding: 8px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 4px 4px 0 0;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.9rem;
    }
    .tab.active { background: var(--accent); color: #000; }
    .panel { display: none; }
    .panel.active { display: block; }

    /* Columns */
    .columns-container { display: grid; gap: 8px; margin-bottom: 12px; }
    .columns-container.cols-2 { grid-template-columns: repeat(2, 1fr); }
    .columns-container.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .columns-container.cols-4 { grid-template-columns: repeat(4, 1fr); }
    .columns-container.cols-5 { grid-template-columns: repeat(5, 1fr); }
    .columns-container.cols-6 { grid-template-columns: repeat(6, 1fr); }

    .search-column {
      background: var(--card);
      border-radius: 6px;
      padding: 8px;
      min-height: 180px;
    }
    .search-column input {
      width: 100%;
      padding: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    .search-column input:focus { outline: none; border-color: var(--accent); }

    /* Result Card */
    .result-card {
      background: var(--bg);
      border-radius: 4px;
      padding: 10px;
      border-left: 3px solid var(--border);
    }
    .result-card.fir-need { border-left-color: var(--red); }
    .result-card.fir-partial { border-left-color: var(--yellow); }
    .result-card.fir-complete { border-left-color: var(--green); }

    .result-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      word-break: break-word;
    }

    /* Price Tier Colors */
    .price-tier {
      font-size: 1.1rem;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 6px;
    }
    .price-tier.none { color: var(--muted); }
    .price-tier.low { color: #6cb6ff; } /* blue-ish */
    .price-tier.mid { color: #f0883e; } /* orange */
    .price-tier.high { color: #f85149; } /* red */
    .price-tier.bronze {
      color: #000;
      background: linear-gradient(135deg, #cd7f32, #8b4513);
      text-shadow: 0 1px 1px rgba(255,255,255,0.3);
    }
    .price-tier.silver {
      color: #000;
      background: linear-gradient(135deg, #e8e8e8, #a8a8a8);
      text-shadow: 0 1px 1px rgba(255,255,255,0.5);
    }
    .price-tier.gold {
      color: #000;
      background: linear-gradient(135deg, #ffd700, #daa520);
      text-shadow: 0 1px 1px rgba(255,255,255,0.5);
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    .result-row .label { color: var(--muted); }
    .result-row .value { font-weight: 500; }
    .result-row .value.need { color: var(--red); }
    .result-row .value.ok { color: var(--green); }

    .result-sources {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--muted);
    }
    .source-item {
      display: inline-block;
      background: #21262d;
      padding: 2px 6px;
      border-radius: 3px;
      margin: 2px 2px 2px 0;
    }
    .source-item.quest { border-left: 2px solid var(--green); }
    .source-item.hideout { border-left: 2px solid var(--blue); }

    .no-result {
      color: var(--muted);
      font-size: 0.85rem;
      text-align: center;
      padding: 20px;
    }

    .fir-badge {
      display: inline-block;
      background: var(--green);
      color: #000;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 6px;
    }

    /* History */
    .history-section {
      background: var(--card);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-header h3 { font-size: 0.9rem; color: var(--muted); }
    .history-header button {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--muted);
      font-size: 0.75rem;
      cursor: pointer;
    }
    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 6px;
    }
    .history-item {
      background: var(--bg);
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      border-left: 3px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-item:hover { background: #21262d; }
    .history-item .name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }
    .history-item .price { font-size: 0.75rem; }

    /* Bulk */
    .bulk-section {
      background: var(--card);
      padding: 16px;
      border-radius: 6px;
    }
    .bulk-section textarea {
      width: 100%;
      height: 100px;
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-family: inherit;
      resize: vertical;
      margin-bottom: 10px;
    }
    .bulk-actions { display: flex; gap: 8px; margin-bottom: 12px; }
    .bulk-actions button {
      padding: 8px 16px;
      background: var(--accent);
      border: none;
      border-radius: 4px;
      color: #000;
      cursor: pointer;
    }
    .bulk-results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
    }

    .setting-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
    }

    @media (max-width: 800px) {
      .columns-container { grid-template-columns: repeat(2, 1fr) !important; }
    }
    @media (max-width: 500px) {
      .columns-container { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Tarkov Item Lookup</h1>
    <div class="header-controls">
      <select id="col-count">
        <option value="2">2列</option>
        <option value="3" selected>3列</option>
        <option value="4">4列</option>
        <option value="5">5列</option>
        <option value="6">6列</option>
      </select>
      <label class="setting-item">
        <input type="checkbox" id="show-details" checked>
        <span>詳細</span>
      </label>
      <button id="btn-fetch">データ取得</button>
      <span class="status" id="api-status">未取得</span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-panel="search">クイック検索</div>
    <div class="tab" data-panel="bulk">一括検索</div>
  </div>

  <div class="panel active" id="panel-search">
    <div class="history-section">
      <div class="history-header">
        <h3>最近の検索</h3>
        <button onclick="clearHistory()">クリア</button>
      </div>
      <div class="history-grid" id="history-grid"></div>
    </div>
    <div class="columns-container cols-3" id="columns-container"></div>
  </div>

  <div class="panel" id="panel-bulk">
    <div class="bulk-section">
      <textarea id="bulk-input" placeholder="アイテム名を1行ずつ入力..."></textarea>
      <div class="bulk-actions">
        <button onclick="bulkSearch()">検索</button>
        <button onclick="clearBulk()" style="background:var(--card);color:var(--text);border:1px solid var(--border);">クリア</button>
      </div>
      <div class="bulk-results" id="bulk-results"></div>
    </div>
  </div>

  <script>
    const BASE_DATA = PLACEHOLDER_DATA;

    // State
    let allItems = {};      // All items (FiR + non-FiR)
    let firItems = {};      // FiR item IDs with requirements
    let searchHistory = [];
    let showDetails = true;

    // Cookie
    function getCookie(n) { const m = document.cookie.match(new RegExp('(^| )'+n+'=([^;]+)')); return m ? m[2] : null; }
    function setCookie(n, v, d=365) { document.cookie = `${n}=${v}; expires=${new Date(Date.now()+d*864e5).toUTCString()}; path=/; SameSite=Lax`; }

    function loadProgress() {
      const s = getCookie('tarkov_fir_v2');
      if (s) try { return JSON.parse(decodeURIComponent(s)); } catch(e) {}
      return {};
    }
    function loadHistory() {
      const s = getCookie('tarkov_history');
      if (s) try { searchHistory = JSON.parse(decodeURIComponent(s)); } catch(e) { searchHistory = []; }
    }
    function saveHistory() {
      setCookie('tarkov_history', encodeURIComponent(JSON.stringify(searchHistory.slice(0, 30))));
    }

    // Init FiR data from embedded
    function initFirData() {
      Object.entries(BASE_DATA.items || {}).forEach(([id, item]) => {
        firItems[id] = {
          totalRequired: item.totalRequired,
          sources: item.questBreakdown.map(q => ({
            type: 'quest',
            name: q.questName,
            count: q.count
          }))
        };
      });
    }

    // Fetch all items from API
    async function fetchData() {
      const btn = document.getElementById('btn-fetch');
      const status = document.getElementById('api-status');
      btn.disabled = true;
      status.textContent = '取得中...';
      status.className = 'status';

      const query = `{
        items {
          id name shortName
          avg24hPrice width height
          types
        }
        hideoutStations {
          name
          levels {
            level
            itemRequirements {
              item { id name shortName }
              count
              attributes { name value }
            }
          }
        }
      }`;

      try {
        const res = await fetch('https://api.tarkov.dev/graphql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        const json = await res.json();
        if (json.errors) throw new Error(json.errors[0].message);

        const data = json.data;

        // Build all items
        allItems = {};
        data.items.forEach(item => {
          const slots = (item.width || 1) * (item.height || 1);
          const perSlot = item.avg24hPrice ? Math.round(item.avg24hPrice / slots) : 0;

          allItems[item.id] = {
            id: item.id,
            name: item.name,
            nameShort: item.shortName,
            price: item.avg24hPrice,
            slots,
            perSlot,
            types: item.types || [],
            fir: null // Will be set if FiR required
          };
        });

        // Match FiR items by name
        Object.entries(BASE_DATA.items || {}).forEach(([baseId, baseItem]) => {
          const match = Object.values(allItems).find(i =>
            i.name.toLowerCase() === baseItem.name.toLowerCase()
          );
          if (match) {
            match.fir = {
              totalRequired: baseItem.totalRequired,
              sources: baseItem.questBreakdown.map(q => ({
                type: 'quest',
                name: q.questName,
                count: q.count
              }))
            };
          }
        });

        // Add hideout FiR
        data.hideoutStations.forEach(station => {
          station.levels.forEach(level => {
            level.itemRequirements.forEach(req => {
              const isFir = req.attributes?.some(a => a.name === 'foundInRaid' && a.value === 'true');
              if (isFir && allItems[req.item.id]) {
                const item = allItems[req.item.id];
                if (!item.fir) {
                  item.fir = { totalRequired: 0, sources: [] };
                }
                item.fir.totalRequired += req.count;
                item.fir.sources.push({
                  type: 'hideout',
                  name: `${station.name} Lv${level.level}`,
                  count: req.count
                });
              }
            });
          });
        });

        status.textContent = `${Object.keys(allItems).length}件取得`;
        status.className = 'status ok';
        renderHistory();

      } catch (err) {
        status.textContent = 'エラー';
        console.error(err);
      } finally {
        btn.disabled = false;
      }
    }

    // Price tier
    function getPriceTier(perSlot) {
      if (!perSlot || perSlot < 10000) return 'none';
      if (perSlot >= 100000) return 'gold';
      if (perSlot >= 50000) return 'silver';
      if (perSlot >= 30000) return 'bronze';
      if (perSlot >= 20000) return 'high';
      if (perSlot >= 15000) return 'mid';
      return 'low';
    }

    function formatPrice(p) {
      if (!p) return '-';
      if (p >= 1000000) return (p/1000000).toFixed(1)+'M';
      if (p >= 1000) return Math.round(p/1000)+'K';
      return p.toString();
    }

    // Search
    function searchItem(query) {
      if (!query || Object.keys(allItems).length === 0) return null;
      const q = query.toLowerCase();
      const matches = Object.values(allItems).filter(item =>
        item.name.toLowerCase().includes(q) ||
        (item.nameShort && item.nameShort.toLowerCase().includes(q))
      );
      matches.sort((a, b) => {
        const aExact = a.name.toLowerCase() === q || (a.nameShort||'').toLowerCase() === q;
        const bExact = b.name.toLowerCase() === q || (b.nameShort||'').toLowerCase() === q;
        if (aExact !== bExact) return aExact ? -1 : 1;
        const aStarts = a.name.toLowerCase().startsWith(q);
        const bStarts = b.name.toLowerCase().startsWith(q);
        if (aStarts !== bStarts) return aStarts ? -1 : 1;
        return a.name.length - b.name.length;
      });
      return matches[0] || null;
    }

    function addToHistory(itemId) {
      if (!itemId) return;
      searchHistory = searchHistory.filter(id => id !== itemId);
      searchHistory.unshift(itemId);
      searchHistory = searchHistory.slice(0, 30);
      saveHistory();
      renderHistory();
    }

    function clearHistory() {
      searchHistory = [];
      saveHistory();
      renderHistory();
    }

    // Render
    function renderResult(item, container) {
      const progress = loadProgress();
      const tier = getPriceTier(item.perSlot);
      const hasFir = !!item.fir;

      let firHtml = '';
      if (hasFir) {
        const collected = progress[item.id] || 0;
        const total = item.fir.totalRequired;
        const isComplete = collected >= total;
        const isPartial = collected > 0 && !isComplete;
        const statusClass = isComplete ? 'fir-complete' : isPartial ? 'fir-partial' : 'fir-need';

        let sourcesHtml = '';
        if (showDetails && item.fir.sources.length > 0) {
          sourcesHtml = `<div class="result-sources">
            ${item.fir.sources.map(s => `<span class="source-item ${s.type}">${s.name} x${s.count}</span>`).join('')}
          </div>`;
        }

        firHtml = `
          <div class="result-row">
            <span class="label">FiR必要</span>
            <span class="value">${total}個</span>
          </div>
          <div class="result-row">
            <span class="label">収集</span>
            <span class="value ${isComplete ? 'ok' : 'need'}">${collected}/${total}</span>
          </div>
          ${sourcesHtml}
        `;

        container.innerHTML = `
          <div class="result-card ${statusClass}">
            <div class="result-name">${item.name}<span class="fir-badge">FiR</span></div>
            <div class="price-tier ${tier}">${formatPrice(item.perSlot)}/slot</div>
            <div class="result-row">
              <span class="label">価格</span>
              <span class="value">${formatPrice(item.price)} (${item.slots}slot)</span>
            </div>
            ${firHtml}
          </div>
        `;
      } else {
        container.innerHTML = `
          <div class="result-card">
            <div class="result-name">${item.name}</div>
            <div class="price-tier ${tier}">${formatPrice(item.perSlot)}/slot</div>
            <div class="result-row">
              <span class="label">価格</span>
              <span class="value">${formatPrice(item.price)} (${item.slots}slot)</span>
            </div>
          </div>
        `;
      }
    }

    function createColumns() {
      const count = parseInt(document.getElementById('col-count').value);
      const container = document.getElementById('columns-container');
      container.className = `columns-container cols-${count}`;
      container.innerHTML = '';

      for (let i = 0; i < count; i++) {
        const col = document.createElement('div');
        col.className = 'search-column';
        col.innerHTML = `
          <input type="text" placeholder="アイテム名..." data-col="${i}">
          <div class="result-container" id="result-${i}">
            <div class="no-result">検索してください</div>
          </div>
        `;
        container.appendChild(col);

        col.querySelector('input').addEventListener('input', (e) => {
          const query = e.target.value.trim();
          const rc = document.getElementById(`result-${i}`);
          if (!query) {
            rc.innerHTML = '<div class="no-result">検索してください</div>';
            return;
          }
          const item = searchItem(query);
          if (item) {
            renderResult(item, rc);
            addToHistory(item.id);
          } else {
            rc.innerHTML = '<div class="no-result">見つかりません</div>';
          }
        });
      }
    }

    function renderHistory() {
      const grid = document.getElementById('history-grid');
      if (searchHistory.length === 0 || Object.keys(allItems).length === 0) {
        grid.innerHTML = '<div class="no-result">履歴なし</div>';
        return;
      }

      grid.innerHTML = searchHistory.slice(0, 15).map(id => {
        const item = allItems[id];
        if (!item) return '';
        const tier = getPriceTier(item.perSlot);
        return `
          <div class="history-item" onclick="fillSearch('${item.name.replace(/'/g, "\\'")}')">
            <span class="name">${item.nameShort || item.name.slice(0,12)}</span>
            <span class="price price-tier ${tier}" style="font-size:0.75rem;padding:2px 4px;">${formatPrice(item.perSlot)}</span>
          </div>
        `;
      }).join('');
    }

    function fillSearch(name) {
      const input = document.querySelector('.search-column input');
      if (input) {
        input.value = name;
        input.dispatchEvent(new Event('input'));
      }
    }

    // Bulk
    function bulkSearch() {
      const terms = document.getElementById('bulk-input').value.split('\n').map(s => s.trim()).filter(s => s);
      const container = document.getElementById('bulk-results');

      if (terms.length === 0) {
        container.innerHTML = '<div class="no-result">入力してください</div>';
        return;
      }

      container.innerHTML = terms.map(term => {
        const item = searchItem(term);
        if (!item) return `<div class="result-card"><div class="result-name">${term}</div><div class="no-result">見つかりません</div></div>`;

        const tier = getPriceTier(item.perSlot);
        const firLabel = item.fir ? `<span class="fir-badge">FiR ${item.fir.totalRequired}</span>` : '';

        return `
          <div class="result-card">
            <div class="result-name">${item.nameShort || item.name.slice(0,20)}${firLabel}</div>
            <div class="price-tier ${tier}" style="font-size:0.9rem;">${formatPrice(item.perSlot)}/s</div>
          </div>
        `;
      }).join('');
    }

    function clearBulk() {
      document.getElementById('bulk-input').value = '';
      document.getElementById('bulk-results').innerHTML = '';
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.panel).classList.add('active');
      });
    });

    // Settings
    document.getElementById('col-count').addEventListener('change', createColumns);
    document.getElementById('show-details').addEventListener('change', (e) => {
      showDetails = e.target.checked;
      document.querySelectorAll('.search-column input').forEach(input => {
        input.dispatchEvent(new Event('input'));
      });
    });

    // Init
    initFirData();
    loadHistory();
    createColumns();
    fetchData();
  </script>
</body>
</html>
