<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarkov FiR Lookup</title>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --muted: #8b949e;
      --accent: #f0883e;
      --green: #3fb950;
      --yellow: #d29922;
      --red: #f85149;
      --blue: #58a6ff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 12px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .header h1 { font-size: 1.2rem; color: var(--accent); }
    .header-controls { display: flex; gap: 8px; align-items: center; }
    .header-controls button, .header-controls select {
      padding: 6px 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
    }
    .header-controls button:hover { background: #21262d; }
    .status { font-size: 0.8rem; color: var(--muted); }
    .status.ok { color: var(--green); }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    .tab {
      padding: 8px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 4px 4px 0 0;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.9rem;
    }
    .tab.active { background: var(--accent); color: #000; border-color: var(--accent); }
    .panel { display: none; }
    .panel.active { display: block; }

    /* Search Columns */
    .columns-container {
      display: grid;
      gap: 8px;
      margin-bottom: 12px;
    }
    .columns-container.cols-2 { grid-template-columns: repeat(2, 1fr); }
    .columns-container.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .columns-container.cols-4 { grid-template-columns: repeat(4, 1fr); }
    .columns-container.cols-5 { grid-template-columns: repeat(5, 1fr); }
    .columns-container.cols-6 { grid-template-columns: repeat(6, 1fr); }

    .search-column {
      background: var(--card);
      border-radius: 6px;
      padding: 8px;
      min-height: 200px;
    }
    .search-column input {
      width: 100%;
      padding: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    .search-column input:focus { outline: none; border-color: var(--accent); }

    .result-card {
      background: var(--bg);
      border-radius: 4px;
      padding: 10px;
      border-left: 3px solid var(--border);
    }
    .result-card.need { border-left-color: var(--red); }
    .result-card.partial { border-left-color: var(--yellow); }
    .result-card.complete { border-left-color: var(--green); }

    .result-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      word-break: break-word;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    .result-row .label { color: var(--muted); }
    .result-row .value { font-weight: 500; }
    .result-row .value.price { color: var(--blue); }
    .result-row .value.need { color: var(--red); }
    .result-row .value.ok { color: var(--green); }

    .result-sources {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--muted);
    }
    .result-sources.hidden { display: none; }
    .source-item {
      display: inline-block;
      background: #21262d;
      padding: 2px 6px;
      border-radius: 3px;
      margin: 2px 2px 2px 0;
    }
    .source-item.quest { border-left: 2px solid var(--green); }
    .source-item.hideout { border-left: 2px solid var(--blue); }

    .no-result {
      color: var(--muted);
      font-size: 0.85rem;
      text-align: center;
      padding: 20px;
    }

    /* Recent History */
    .history-section {
      background: var(--card);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-header h3 { font-size: 0.9rem; color: var(--muted); }
    .history-header button {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--muted);
      font-size: 0.75rem;
      cursor: pointer;
    }
    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
    }
    .history-item {
      background: var(--bg);
      padding: 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      border-left: 3px solid var(--border);
    }
    .history-item:hover { background: #21262d; }
    .history-item.complete { border-left-color: var(--green); }
    .history-item.partial { border-left-color: var(--yellow); }
    .history-item.need { border-left-color: var(--red); }
    .history-item .name { font-weight: 500; margin-bottom: 4px; }
    .history-item .meta {
      display: flex;
      justify-content: space-between;
      color: var(--muted);
      font-size: 0.8rem;
    }
    .history-item .meta .price { color: var(--blue); }

    /* Bulk Search */
    .bulk-section {
      background: var(--card);
      padding: 16px;
      border-radius: 6px;
    }
    .bulk-section textarea {
      width: 100%;
      height: 100px;
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
      resize: vertical;
      margin-bottom: 10px;
    }
    .bulk-actions { display: flex; gap: 8px; margin-bottom: 12px; }
    .bulk-actions button {
      padding: 8px 16px;
      background: var(--accent);
      border: none;
      border-radius: 4px;
      color: #000;
      cursor: pointer;
    }
    .bulk-results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
    }

    /* Settings */
    .settings {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .setting-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
    }
    .setting-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    @media (max-width: 800px) {
      .columns-container { grid-template-columns: repeat(2, 1fr) !important; }
    }
    @media (max-width: 500px) {
      .columns-container { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Tarkov FiR Lookup</h1>
    <div class="header-controls">
      <select id="col-count">
        <option value="2">2列</option>
        <option value="3" selected>3列</option>
        <option value="4">4列</option>
        <option value="5">5列</option>
        <option value="6">6列</option>
      </select>
      <label class="setting-item">
        <input type="checkbox" id="show-details" checked>
        <span>詳細表示</span>
      </label>
      <button id="btn-fetch">データ取得</button>
      <span class="status" id="api-status">未取得</span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-panel="search">クイック検索</div>
    <div class="tab" data-panel="bulk">一括検索</div>
  </div>

  <!-- クイック検索 -->
  <div class="panel active" id="panel-search">
    <div class="history-section" id="history-section">
      <div class="history-header">
        <h3>最近の検索</h3>
        <button onclick="clearHistory()">クリア</button>
      </div>
      <div class="history-grid" id="history-grid"></div>
    </div>

    <div class="columns-container cols-3" id="columns-container"></div>
  </div>

  <!-- 一括検索 -->
  <div class="panel" id="panel-bulk">
    <div class="bulk-section">
      <textarea id="bulk-input" placeholder="アイテム名を1行ずつ入力..."></textarea>
      <div class="bulk-actions">
        <button onclick="bulkSearch()">検索</button>
        <button onclick="clearBulk()" style="background:var(--card);color:var(--text);border:1px solid var(--border);">クリア</button>
      </div>
      <div class="bulk-results" id="bulk-results"></div>
    </div>
  </div>

  <script>
    const BASE_DATA = PLACEHOLDER_DATA;

    // State
    let allItems = {};
    let priceData = {};
    let searchHistory = [];
    let showDetails = true;

    // Cookie helpers
    function getCookie(n) { const m = document.cookie.match(new RegExp('(^| )'+n+'=([^;]+)')); return m ? m[2] : null; }
    function setCookie(n, v, d=365) { document.cookie = `${n}=${v}; expires=${new Date(Date.now()+d*864e5).toUTCString()}; path=/; SameSite=Lax`; }

    function loadProgress() {
      const saved = getCookie('tarkov_fir_v2');
      if (saved) try { return JSON.parse(decodeURIComponent(saved)); } catch(e) {}
      return {};
    }
    function saveProgress(progress) {
      setCookie('tarkov_fir_v2', encodeURIComponent(JSON.stringify(progress)));
    }
    function loadHistory() {
      const saved = getCookie('tarkov_history');
      if (saved) try { searchHistory = JSON.parse(decodeURIComponent(saved)); } catch(e) { searchHistory = []; }
    }
    function saveHistory() {
      setCookie('tarkov_history', encodeURIComponent(JSON.stringify(searchHistory.slice(0, 20))));
    }

    // Init from base data
    function initData() {
      Object.entries(BASE_DATA.items || {}).forEach(([id, item]) => {
        allItems[id] = {
          id,
          name: item.name,
          nameShort: item.nameShort,
          totalRequired: item.totalRequired,
          sources: item.questBreakdown.map(q => ({
            type: 'quest',
            name: q.questName,
            count: q.count,
            level: q.level
          })),
          canCraft: item.canCraft
        };
      });
    }

    // Fetch API
    async function fetchData() {
      const btn = document.getElementById('btn-fetch');
      const status = document.getElementById('api-status');
      btn.disabled = true;
      status.textContent = '取得中...';
      status.className = 'status';

      const query = `{
        items { name shortName avg24hPrice width height }
        hideoutStations {
          name
          levels {
            level
            itemRequirements {
              item { name shortName }
              count
              attributes { name value }
            }
          }
        }
      }`;

      try {
        const res = await fetch('https://api.tarkov.dev/graphql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        const json = await res.json();
        if (json.errors) throw new Error(json.errors[0].message);

        const data = json.data;

        // Price lookup
        const priceByName = {};
        data.items.forEach(item => {
          priceByName[item.name.toLowerCase()] = item;
          if (item.shortName) priceByName[item.shortName.toLowerCase()] = item;
        });

        Object.values(allItems).forEach(item => {
          const match = priceByName[item.name.toLowerCase()] || priceByName[(item.nameShort||'').toLowerCase()];
          if (match) {
            const slots = (match.width||1) * (match.height||1);
            priceData[item.id] = {
              avg: match.avg24hPrice,
              slots,
              perSlot: match.avg24hPrice ? Math.round(match.avg24hPrice / slots) : 0
            };
          }
        });

        // Hideout FiR
        data.hideoutStations.forEach(station => {
          station.levels.forEach(level => {
            level.itemRequirements.forEach(req => {
              const isFir = req.attributes?.some(a => a.name === 'foundInRaid' && a.value === 'true');
              if (isFir) {
                const key = req.item.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                const existing = Object.values(allItems).find(i => i.name.toLowerCase() === req.item.name.toLowerCase());
                if (existing) {
                  existing.sources.push({
                    type: 'hideout',
                    name: `${station.name} Lv${level.level}`,
                    count: req.count,
                    level: level.level
                  });
                  existing.totalRequired += req.count;
                } else {
                  const id = `hideout_${key}`;
                  allItems[id] = {
                    id,
                    name: req.item.name,
                    nameShort: req.item.shortName,
                    totalRequired: req.count,
                    sources: [{
                      type: 'hideout',
                      name: `${station.name} Lv${level.level}`,
                      count: req.count,
                      level: level.level
                    }],
                    canCraft: false
                  };
                  const match = priceByName[req.item.name.toLowerCase()];
                  if (match) {
                    const slots = (match.width||1) * (match.height||1);
                    priceData[id] = {
                      avg: match.avg24hPrice,
                      slots,
                      perSlot: match.avg24hPrice ? Math.round(match.avg24hPrice / slots) : 0
                    };
                  }
                }
              }
            });
          });
        });

        status.textContent = '取得完了';
        status.className = 'status ok';
        renderHistory();
      } catch (err) {
        status.textContent = 'エラー';
        status.className = 'status';
        console.error(err);
      } finally {
        btn.disabled = false;
      }
    }

    // Search
    function searchItem(query) {
      if (!query) return null;
      const q = query.toLowerCase();
      const matches = Object.values(allItems).filter(item =>
        item.name.toLowerCase().includes(q) ||
        (item.nameShort && item.nameShort.toLowerCase().includes(q))
      );
      // Best match: exact or starts with
      matches.sort((a, b) => {
        const aExact = a.name.toLowerCase() === q || (a.nameShort||'').toLowerCase() === q;
        const bExact = b.name.toLowerCase() === q || (b.nameShort||'').toLowerCase() === q;
        if (aExact && !bExact) return -1;
        if (bExact && !aExact) return 1;
        const aStarts = a.name.toLowerCase().startsWith(q);
        const bStarts = b.name.toLowerCase().startsWith(q);
        if (aStarts && !bStarts) return -1;
        if (bStarts && !aStarts) return 1;
        return a.name.length - b.name.length;
      });
      return matches[0] || null;
    }

    function addToHistory(itemId) {
      if (!itemId) return;
      searchHistory = searchHistory.filter(id => id !== itemId);
      searchHistory.unshift(itemId);
      searchHistory = searchHistory.slice(0, 20);
      saveHistory();
      renderHistory();
    }

    function clearHistory() {
      searchHistory = [];
      saveHistory();
      renderHistory();
    }

    // Rendering
    function formatPrice(p) {
      if (!p) return '-';
      if (p >= 1000000) return (p/1000000).toFixed(1)+'M';
      if (p >= 1000) return Math.round(p/1000)+'K';
      return p.toString();
    }

    function renderResult(item, container) {
      const progress = loadProgress();
      const collected = progress[item.id] || 0;
      const isComplete = collected >= item.totalRequired;
      const isPartial = collected > 0 && !isComplete;
      const price = priceData[item.id];

      const statusClass = isComplete ? 'complete' : isPartial ? 'partial' : 'need';
      const statusText = isComplete ? '完了' : `あと${item.totalRequired - collected}`;

      let sourcesHtml = '';
      if (showDetails && item.sources.length > 0) {
        sourcesHtml = `<div class="result-sources">
          ${item.sources.map(s => `<span class="source-item ${s.type}">${s.name} x${s.count}</span>`).join('')}
        </div>`;
      }

      container.innerHTML = `
        <div class="result-card ${statusClass}">
          <div class="result-name">${item.name}</div>
          <div class="result-row">
            <span class="label">価格</span>
            <span class="value price">${formatPrice(price?.avg)}</span>
          </div>
          <div class="result-row">
            <span class="label">マス単価</span>
            <span class="value price">${formatPrice(price?.perSlot)}/s</span>
          </div>
          <div class="result-row">
            <span class="label">FiR必要</span>
            <span class="value">${item.totalRequired}個</span>
          </div>
          <div class="result-row">
            <span class="label">収集</span>
            <span class="value ${isComplete ? 'ok' : 'need'}">${collected}/${item.totalRequired} ${statusText}</span>
          </div>
          ${sourcesHtml}
        </div>
      `;
    }

    function createColumns() {
      const count = parseInt(document.getElementById('col-count').value);
      const container = document.getElementById('columns-container');
      container.className = `columns-container cols-${count}`;
      container.innerHTML = '';

      for (let i = 0; i < count; i++) {
        const col = document.createElement('div');
        col.className = 'search-column';
        col.innerHTML = `
          <input type="text" placeholder="アイテム名..." data-col="${i}">
          <div class="result-container" id="result-${i}">
            <div class="no-result">検索してください</div>
          </div>
        `;
        container.appendChild(col);

        const input = col.querySelector('input');
        input.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          const resultContainer = document.getElementById(`result-${i}`);
          if (!query) {
            resultContainer.innerHTML = '<div class="no-result">検索してください</div>';
            return;
          }
          const item = searchItem(query);
          if (item) {
            renderResult(item, resultContainer);
            addToHistory(item.id);
          } else {
            resultContainer.innerHTML = '<div class="no-result">見つかりません</div>';
          }
        });
      }
    }

    function renderHistory() {
      const grid = document.getElementById('history-grid');
      const progress = loadProgress();

      if (searchHistory.length === 0) {
        grid.innerHTML = '<div class="no-result">履歴なし</div>';
        return;
      }

      grid.innerHTML = searchHistory.slice(0, 12).map(id => {
        const item = allItems[id];
        if (!item) return '';
        const collected = progress[id] || 0;
        const isComplete = collected >= item.totalRequired;
        const isPartial = collected > 0 && !isComplete;
        const statusClass = isComplete ? 'complete' : isPartial ? 'partial' : 'need';
        const price = priceData[id];

        return `
          <div class="history-item ${statusClass}" onclick="fillSearch('${item.name}')">
            <div class="name">${item.nameShort || item.name.slice(0, 20)}</div>
            <div class="meta">
              <span>${collected}/${item.totalRequired}</span>
              <span class="price">${formatPrice(price?.avg)}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function fillSearch(name) {
      const firstInput = document.querySelector('.search-column input');
      if (firstInput) {
        firstInput.value = name;
        firstInput.dispatchEvent(new Event('input'));
      }
    }

    // Bulk search
    function bulkSearch() {
      const input = document.getElementById('bulk-input').value;
      const terms = input.split('\n').map(s => s.trim()).filter(s => s);
      const container = document.getElementById('bulk-results');
      const progress = loadProgress();

      if (terms.length === 0) {
        container.innerHTML = '<div class="no-result">入力してください</div>';
        return;
      }

      container.innerHTML = terms.map(term => {
        const item = searchItem(term);
        if (!item) return `<div class="result-card"><div class="result-name">${term}</div><div class="no-result">見つかりません</div></div>`;

        const collected = progress[item.id] || 0;
        const isComplete = collected >= item.totalRequired;
        const price = priceData[item.id];
        const statusClass = isComplete ? 'complete' : collected > 0 ? 'partial' : 'need';

        return `
          <div class="result-card ${statusClass}">
            <div class="result-name">${item.name}</div>
            <div class="result-row">
              <span class="label">価格</span>
              <span class="value price">${formatPrice(price?.avg)}</span>
            </div>
            <div class="result-row">
              <span class="label">FiR</span>
              <span class="value">${collected}/${item.totalRequired}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function clearBulk() {
      document.getElementById('bulk-input').value = '';
      document.getElementById('bulk-results').innerHTML = '';
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.panel).classList.add('active');
      });
    });

    // Settings
    document.getElementById('col-count').addEventListener('change', createColumns);
    document.getElementById('show-details').addEventListener('change', (e) => {
      showDetails = e.target.checked;
      // Re-render current results
      document.querySelectorAll('.search-column input').forEach(input => {
        input.dispatchEvent(new Event('input'));
      });
    });

    // Init
    initData();
    loadHistory();
    createColumns();
    renderHistory();
    fetchData();
  </script>
</body>
</html>
