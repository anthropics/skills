<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarkov FiR Tracker</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { color: #ffa500; margin-bottom: 5px; }
    .subtitle { color: #888; margin-bottom: 20px; }

    .stats {
      background: #2a2a2a;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 4px solid #ffa500;
    }
    .stats-row { display: flex; gap: 30px; flex-wrap: wrap; }
    .stat-value { color: #ffa500; font-size: 1.2em; font-weight: bold; }

    .controls {
      display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;
    }
    input[type="text"], input[type="number"] {
      background: #2a2a2a;
      border: 1px solid #444;
      color: #e0e0e0;
      padding: 8px 12px;
      font-family: inherit;
    }
    #search { flex: 1; min-width: 200px; }
    select, button {
      background: #2a2a2a;
      border: 1px solid #444;
      color: #e0e0e0;
      padding: 8px 12px;
      font-family: inherit;
      cursor: pointer;
    }
    button:hover { background: #3a3a3a; }
    button.reset { background: #8b0000; }
    button.reset:hover { background: #a00000; }
    button.price-btn { background: #006400; }
    button.price-btn:hover { background: #008000; }
    button.price-btn.loading { opacity: 0.5; cursor: wait; }

    .level-filter {
      display: flex; align-items: center; gap: 5px;
    }
    .level-filter input { width: 60px; text-align: center; }

    .item-list { }
    .item {
      background: #2a2a2a;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #444;
      display: grid;
      grid-template-columns: auto 1fr auto auto auto;
      align-items: center;
      gap: 15px;
    }
    .item.complete { border-left-color: #00ff00; opacity: 0.6; }
    .item.partial { border-left-color: #ffff00; }

    .item-level {
      background: #333;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      min-width: 50px;
      text-align: center;
    }
    .item-level.early { background: #006400; color: #90ee90; }
    .item-level.mid { background: #8b8000; color: #ffff90; }
    .item-level.late { background: #8b0000; color: #ff9090; }

    .item-name { min-width: 200px; }
    .item-name strong { color: #fff; }
    .item-type { color: #888; font-size: 0.85em; }

    .item-price {
      font-size: 0.85em;
      color: #00bfff;
      min-width: 100px;
      text-align: right;
    }
    .item-price.loading { color: #666; }
    .price-change { font-size: 0.75em; }
    .price-change.up { color: #ff4444; }
    .price-change.down { color: #44ff44; }

    .item-count {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .item-count input {
      width: 50px;
      text-align: center;
      padding: 5px;
    }
    .item-count button { padding: 5px 10px; }

    .item-progress { min-width: 70px; text-align: right; }
    .item-progress.done { color: #00ff00; }

    .quests { font-size: 0.8em; color: #888; margin-top: 5px; grid-column: 1 / -1; }
    .quest-tag {
      display: inline-block;
      background: #333;
      padding: 2px 6px;
      margin: 2px;
      border-radius: 3px;
    }
    .quest-tag.kappa { border: 1px solid #ffa500; }
    .quest-tag .quest-level { color: #888; font-size: 0.9em; }
    .craft-tag { color: #00bfff; }

    .hidden { display: none; }

    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #333;
      font-size: 0.85em;
      color: #666;
    }
    .footer a { color: #ffa500; }

    .api-status {
      font-size: 0.85em;
      padding: 5px 10px;
      border-radius: 4px;
    }
    .api-status.ok { background: #1a3a1a; color: #90ee90; }
    .api-status.error { background: #3a1a1a; color: #ff9090; }
    .api-status.loading { background: #3a3a1a; color: #ffff90; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tarkov FiR Tracker</h1>
    <p class="subtitle">Found in Raid アイテム収集管理 + 進行状況 + フリマ価格</p>

    <div class="stats">
      <div class="stats-row">
        <div class="stat">
          進捗: <span class="stat-value" id="progress">0/0</span>
        </div>
        <div class="stat">
          完了: <span class="stat-value" id="completed-items">0/0</span>
        </div>
        <div class="stat">
          収集済: <span class="stat-value" id="total-collected">0</span>
        </div>
        <div class="stat">
          <span class="api-status" id="api-status">価格未取得</span>
        </div>
      </div>
    </div>

    <div class="controls">
      <input type="text" id="search" placeholder="アイテム名で検索...">
      <div class="level-filter">
        Lv <input type="number" id="level-min" value="1" min="1" max="70">
        - <input type="number" id="level-max" value="70" min="1" max="70">
      </div>
      <select id="filter">
        <option value="all">すべて</option>
        <option value="incomplete">未完了</option>
        <option value="partial">収集中</option>
        <option value="complete">完了</option>
      </select>
      <select id="sort">
        <option value="priority">進行順 (推奨)</option>
        <option value="level">レベル順</option>
        <option value="required-desc">必要数 多い順</option>
        <option value="name-asc">名前 A-Z</option>
        <option value="price-desc">価格 高い順</option>
      </select>
      <button class="price-btn" id="fetch-prices">価格取得</button>
      <button class="reset" onclick="resetProgress()">リセット</button>
    </div>

    <div class="item-list" id="item-list"></div>

    <div class="footer">
      <p>データ: <a href="https://github.com/TarkovTracker/tarkovdata" target="_blank">TarkovTracker</a> | 価格: <a href="https://tarkov.dev/api/" target="_blank">tarkov.dev API</a></p>
      <p>進捗はCookieに保存 | 価格はセッション中のみ</p>
    </div>
  </div>

  <script>
    // Embedded FiR data (replaced by build script)
    const FIR_DATA = PLACEHOLDER_DATA;

    // ============================================
    // Cookie Storage
    // ============================================
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, days = 365) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
    }

    // ============================================
    // Progress State
    // ============================================
    let progress = {};
    let priceData = {};

    function loadProgress() {
      const saved = getCookie('tarkov_fir_progress');
      if (saved) {
        try {
          progress = JSON.parse(decodeURIComponent(saved));
        } catch (e) {
          progress = {};
        }
      }
    }

    function saveProgress() {
      setCookie('tarkov_fir_progress', encodeURIComponent(JSON.stringify(progress)));
    }

    function getCollected(itemId) {
      return progress[itemId] || 0;
    }

    function setCollected(itemId, count) {
      const item = FIR_DATA.items[itemId];
      if (!item) return;
      count = Math.max(0, Math.min(count, item.totalRequired));
      if (count === 0) {
        delete progress[itemId];
      } else {
        progress[itemId] = count;
      }
      saveProgress();
      updateStats();
      renderItems();
    }

    // ============================================
    // Price Fetching (tarkov.dev API)
    // ============================================
    async function fetchPrices() {
      const btn = document.getElementById('fetch-prices');
      const status = document.getElementById('api-status');

      btn.classList.add('loading');
      btn.disabled = true;
      status.textContent = '価格取得中...';
      status.className = 'api-status loading';

      // Get item names to search
      const itemNames = Object.values(FIR_DATA.items).map(i => i.name);

      const query = `
        query {
          items {
            id
            name
            shortName
            avg24hPrice
            low24hPrice
            high24hPrice
            changeLast48hPercent
            iconLink
          }
        }
      `;

      try {
        const response = await fetch('https://api.tarkov.dev/graphql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        if (data.errors) throw new Error(data.errors[0].message);

        // Build price lookup by name
        const priceByName = {};
        data.data.items.forEach(item => {
          priceByName[item.name.toLowerCase()] = item;
          priceByName[item.shortName.toLowerCase()] = item;
        });

        // Match to our items
        Object.entries(FIR_DATA.items).forEach(([id, item]) => {
          const match = priceByName[item.name.toLowerCase()] ||
                        priceByName[item.nameShort.toLowerCase()];
          if (match) {
            priceData[id] = {
              avg: match.avg24hPrice,
              low: match.low24hPrice,
              high: match.high24hPrice,
              change: match.changeLast48hPercent,
              icon: match.iconLink
            };
          }
        });

        status.textContent = `価格取得完了 (${Object.keys(priceData).length}件)`;
        status.className = 'api-status ok';
        renderItems();

      } catch (err) {
        console.error('Price fetch error:', err);
        status.textContent = `エラー: ${err.message}`;
        status.className = 'api-status error';
      } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }

    function formatPrice(price) {
      if (!price) return '-';
      if (price >= 1000000) return (price / 1000000).toFixed(1) + 'M';
      if (price >= 1000) return Math.round(price / 1000) + 'K';
      return price.toString();
    }

    // ============================================
    // Stats
    // ============================================
    function updateStats() {
      let totalRequired = 0;
      let totalCollected = 0;
      let completedItems = 0;
      const itemCount = Object.keys(FIR_DATA.items).length;

      for (const [id, item] of Object.entries(FIR_DATA.items)) {
        totalRequired += item.totalRequired;
        const collected = getCollected(id);
        totalCollected += collected;
        if (collected >= item.totalRequired) {
          completedItems++;
        }
      }

      document.getElementById('progress').textContent = `${totalCollected}/${totalRequired}`;
      document.getElementById('completed-items').textContent = `${completedItems}/${itemCount}`;
      document.getElementById('total-collected').textContent = totalCollected;
    }

    // ============================================
    // Render
    // ============================================
    function renderItems() {
      const search = document.getElementById('search').value.toLowerCase();
      const filter = document.getElementById('filter').value;
      const sort = document.getElementById('sort').value;
      const levelMin = parseInt(document.getElementById('level-min').value) || 1;
      const levelMax = parseInt(document.getElementById('level-max').value) || 70;

      let items = Object.entries(FIR_DATA.items).map(([id, item]) => ({
        id,
        ...item,
        collected: getCollected(id),
        price: priceData[id]
      }));

      // Filter
      items = items.filter(item => {
        if (search && !item.name.toLowerCase().includes(search)) return false;

        const level = item.earliestAccess?.level || 1;
        if (level < levelMin || level > levelMax) return false;

        const isComplete = item.collected >= item.totalRequired;
        const isPartial = item.collected > 0 && !isComplete;
        if (filter === 'incomplete' && isComplete) return false;
        if (filter === 'partial' && !isPartial) return false;
        if (filter === 'complete' && !isComplete) return false;

        return true;
      });

      // Sort
      items.sort((a, b) => {
        switch (sort) {
          case 'priority':
            return (a.earliestAccess?.priority || 999) - (b.earliestAccess?.priority || 999);
          case 'level':
            return (a.earliestAccess?.level || 99) - (b.earliestAccess?.level || 99);
          case 'required-desc':
            return b.totalRequired - a.totalRequired;
          case 'name-asc':
            return a.name.localeCompare(b.name);
          case 'price-desc':
            return (b.price?.avg || 0) - (a.price?.avg || 0);
          default:
            return 0;
        }
      });

      const list = document.getElementById('item-list');
      list.innerHTML = items.map(item => {
        const isComplete = item.collected >= item.totalRequired;
        const isPartial = item.collected > 0 && !isComplete;
        const statusClass = isComplete ? 'complete' : isPartial ? 'partial' : '';
        const progressClass = isComplete ? 'done' : '';

        const level = item.earliestAccess?.level || '?';
        const levelClass = level <= 10 ? 'early' : level <= 25 ? 'mid' : 'late';

        const questTags = item.questBreakdown.map(q =>
          `<span class="quest-tag${q.kappa ? ' kappa' : ''}">
            <span class="quest-level">Lv${q.level}</span> ${q.questName} (${q.count})
          </span>`
        ).join('');

        const craftInfo = item.canCraft
          ? `<span class="craft-tag">[Craft]</span>`
          : '';

        // Price display
        let priceHtml = '<span class="item-price">-</span>';
        if (item.price) {
          const changeClass = item.price.change > 0 ? 'up' : item.price.change < 0 ? 'down' : '';
          const changeSign = item.price.change > 0 ? '+' : '';
          priceHtml = `
            <span class="item-price">
              ${formatPrice(item.price.avg)}
              <span class="price-change ${changeClass}">${changeSign}${item.price.change?.toFixed(1) || 0}%</span>
            </span>
          `;
        }

        return `
          <div class="item ${statusClass}">
            <div class="item-level ${levelClass}">Lv${level}</div>
            <div class="item-name">
              <strong>${item.name}</strong>
              <div class="item-type">${item.type} ${craftInfo}</div>
            </div>
            ${priceHtml}
            <div class="item-count">
              <button onclick="setCollected('${item.id}', ${item.collected - 1})">-</button>
              <input type="number" value="${item.collected}" min="0" max="${item.totalRequired}"
                onchange="setCollected('${item.id}', parseInt(this.value) || 0)">
              <button onclick="setCollected('${item.id}', ${item.collected + 1})">+</button>
            </div>
            <div class="item-progress ${progressClass}">
              ${item.collected}/${item.totalRequired}
            </div>
            <div class="quests">${questTags}</div>
          </div>
        `;
      }).join('');
    }

    function resetProgress() {
      if (confirm('すべての進捗をリセットしますか？')) {
        progress = {};
        saveProgress();
        updateStats();
        renderItems();
      }
    }

    // ============================================
    // Event Listeners
    // ============================================
    document.getElementById('search').addEventListener('input', renderItems);
    document.getElementById('filter').addEventListener('change', renderItems);
    document.getElementById('sort').addEventListener('change', renderItems);
    document.getElementById('level-min').addEventListener('change', renderItems);
    document.getElementById('level-max').addEventListener('change', renderItems);
    document.getElementById('fetch-prices').addEventListener('click', fetchPrices);

    // ============================================
    // Initialize
    // ============================================
    loadProgress();
    updateStats();
    renderItems();
  </script>
</body>
</html>
